parameters:
  buildConfig: ''
  archType: ''
  osGroup: ''
  osSubgroup: ''
  platform: ''
  runtimeVariant: ''
  uploadTests: false
  testFilter: tree nativeaot
  runSingleFileTests: true
  isOfficialBuild: false
  librariesConfiguration: Debug

steps:
- ${{ if and(ne(parameters.archType, 'arm'), ne(parameters.archType, 'arm64')) }}:

  # For NativeAOT-LLVM, we have just built the Wasm-targeting native artifacts (the runtime and libraries).
  # Now we need to build the cross-targeting compilers, RyuJit and ILC. Likewise with packages.

  - ${{ if eq(parameters.archType, 'wasm') }}:
    - script: $(Build.SourcesDirectory)/build$(scriptExt) clr.wasmjit+clr.aot -c $(buildConfigUpper) $(_officialBuildParameter) -ci
      displayName: Build the ILC and RyuJit cross-compilers

    - ${{ if and(eq(parameters.isOfficialBuild, true), eq(parameters.platform, 'browser_wasm_win')) }}:
      - script: $(Build.SourcesDirectory)/build$(scriptExt) libs+nativeaot.packages -c $(buildConfigUpper) $(_officialBuildParameter) -ci
        displayName: Build host packages

  # Build coreclr native test output
  - ${{ if eq(parameters.platform, 'browser_wasm_win') }}:
    - script: |
        call $(Build.SourcesDirectory)\wasm-tools\emsdk\emsdk_env
        $(Build.SourcesDirectory)/src/tests/build$(scriptExt) nativeaot $(buildConfigUpper) ${{ parameters.archType }} tree nativeaot
      displayName: Build WebAssembly tests
  - ${{ elseif eq(parameters.platform, 'wasi_wasm_win') }}:
    - script: |
        call $(Build.SourcesDirectory)\wasm-tools\emsdk\emsdk_env
        $(Build.SourcesDirectory)/src/tests/build$(scriptExt) nativeaot $(buildConfigUpper) ${{ parameters.archType }} wasi tree nativeaot
      displayName: Build WebAssembly tests

  - ${{ elseif eq(parameters.osGroup, 'windows') }}:
    - script: $(Build.SourcesDirectory)/src/tests/build$(scriptExt) nativeaot $(buildConfigUpper) ${{ parameters.archType }} ${{ parameters.testFilter }} /p:NativeAotMultimodule=true /p:LibrariesConfiguration=${{ parameters.librariesConfiguration }}
      displayName: Build tests
  - ${{ else }}:
    - script: $(Build.SourcesDirectory)/src/tests/build$(scriptExt) nativeaot $(buildConfigUpper) ${{ parameters.archType }} 'tree nativeaot' /p:LibrariesConfiguration=${{ parameters.librariesConfiguration }}
      displayName: Build tests

  - ${{ if eq(parameters.runSingleFileTests, true) }}:
    - ${{ if in(parameters.platform, 'browser_wasm_win', 'wasi_wasm_win') }}:
      - script: |
          call $(Build.SourcesDirectory)\wasm-tools\emsdk\emsdk_env
          $(Build.SourcesDirectory)/src/tests/run$(scriptExt) runnativeaottests $(buildConfigUpper) ${{ parameters.archType }} ${{ parameters.osGroup }}
        displayName: Run WebAssembly tests in single file mode
    - ${{ elseif eq(parameters.osGroup, 'windows') }}:
      - script: $(Build.SourcesDirectory)/src/tests/run$(scriptExt) runnativeaottests $(buildConfigUpper) ${{ parameters.archType }}
        displayName: Run tests in single file mode
    - ${{ else }}:
      - script: $(Build.SourcesDirectory)/src/tests/run$(scriptExt) --runnativeaottests $(buildConfigUpper) ${{ parameters.archType }}
        displayName: Run tests in single file mode

  # Zip CoreCLR Build Output
  - template: /eng/pipelines/common/upload-artifact-step.yml
    parameters:
      rootFolder: $(Build.SourcesDirectory)/artifacts/bin/coreclr/${{ parameters.osGroup }}.${{ parameters.archType }}.$(buildConfigUpper)
      archiveType: $(archiveType)
      tarCompression: $(tarCompression)
      includeRootFolder: false
      archiveExtension: $(archiveExtension)
      artifactName: CoreCLRProduct_${{ parameters.runtimeVariant }}_${{ parameters.osGroup }}${{ parameters.osSubgroup }}_${{ parameters.archType }}_${{ parameters.buildConfig }}
      displayName: 'CoreCLR product build'

  # Zip Test Build
  - ${{ if eq(parameters.uploadLibrariesTests, true) }}:
    - template: /eng/pipelines/common/upload-artifact-step.yml
      parameters:
        rootFolder: $(Build.SourcesDirectory)/artifacts/helix
        includeRootFolder: true
        archiveType: $(archiveType)
        archiveExtension: $(archiveExtension)
        tarCompression: $(tarCompression)
        artifactName: libraries_test_assets_${{ parameters.osGroup }}_${{ parameters.archType }}_${{ parameters.buildConfig }}
        displayName: Test Assets

  # Zip runtime native assets for use by Tests
  - ${{ if eq(parameters.uploadRuntimeTests, true) }}:
    - template: /eng/pipelines/common/upload-artifact-step.yml
      parameters:
        rootFolder: $(Build.SourcesDirectory)/artifacts/tests/coreclr/obj/${{ parameters.osGroup }}.${{ parameters.archType }}.$(buildConfigUpper)
        includeRootFolder: false
        archiveType: $(archiveType)
        tarCompression: $(tarCompression)
        archiveExtension: $(archiveExtension)
        artifactName: CoreCLRNativeTestArtifacts_${{ parameters.osGroup }}${{ parameters.osSubgroup }}_${{ parameters.archType }}_${{ parameters.buildConfig }}
        displayName: 'native test components'

  # Zip Libraries Build Output
  - template: /eng/pipelines/common/upload-artifact-step.yml
    parameters:
      rootFolder: $(Build.ArtifactStagingDirectory)/artifacts
      archiveType: $(archiveType)
      tarCompression: $(tarCompression)
      includeRootFolder: false
      archiveExtension: $(archiveExtension)
      artifactName: ${{ coalesce(parameters.librariesBinArtifactName, format('libraries_bin_{0}{1}_{2}_{3}', parameters.osGroup, parameters.osSubgroup, parameters.archType, parameters.buildConfig)) }}
      displayName: Build Assets

  # Upload unsigned artifacts
  - ${{ if eq(parameters.uploadIntermediateArtifacts, true) }}:
    - template: /eng/pipelines/common/upload-intermediate-artifacts-step.yml
      parameters:
        name: ${{ parameters.platform }}${{ parameters.nameSuffix }}
